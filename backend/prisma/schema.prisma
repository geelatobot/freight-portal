generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id            String    @id @default(uuid())
  username      String    @unique @db.VarChar(50)
  email         String?   @unique @db.VarChar(100)
  phone         String?   @unique @db.VarChar(20)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  realName      String?   @map("real_name") @db.VarChar(50)
  avatar        String?   @db.VarChar(255)
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime? @map("last_login_at")
  lastLoginIp   String?   @map("last_login_ip") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // 关联
  companyUsers  CompanyUser[]
  orders        Order[]
  
  @@map("users")
}

// 企业表
model Company {
  id              String    @id @default(uuid())
  companyName     String    @map("company_name") @db.VarChar(100)
  creditCode      String?   @map("credit_code") @unique @db.VarChar(50)
  address         String?   @db.Text
  contactName     String?   @map("contact_name") @db.VarChar(50)
  contactPhone    String?   @map("contact_phone") @db.VarChar(20)
  contactEmail    String?   @map("contact_email") @db.VarChar(100)
  creditLimit     Decimal?  @map("credit_limit") @db.Decimal(15, 2)
  creditUsed      Decimal   @default(0) @map("credit_used") @db.Decimal(15, 2)
  status          CompanyStatus @default(PENDING)
  remark          String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // 关联
  companyUsers    CompanyUser[]
  orders          Order[]
  shipments       Shipment[]
  bills           Bill[]
  
  @@map("companies")
}

// 用户企业关联表
model CompanyUser {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  companyId   String    @map("company_id")
  role        CompanyRole @default(OPERATOR)
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // 关联
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([userId, companyId])
  @@map("company_users")
}

// 订单表
model Order {
  id              String      @id @default(uuid())
  orderNo         String      @unique @map("order_no") @db.VarChar(50)
  companyId       String      @map("company_id")
  creatorId       String      @map("creator_id")
  type            OrderType
  status          OrderStatus @default(PENDING)
  subStatus       String?     @map("sub_status") @db.VarChar(50)
  
  // 港口信息
  originPort      String      @map("origin_port") @db.VarChar(50)
  originPortName  String      @map("origin_port_name") @db.VarChar(100)
  destinationPort String      @map("destination_port") @db.VarChar(50)
  destinationPortName String  @map("destination_port_name") @db.VarChar(100)
  
  // 货物信息
  cargoDesc       String      @map("cargo_desc") @db.Text
  cargoWeight     Decimal?    @map("cargo_weight") @db.Decimal(15, 3)
  cargoVolume     Decimal?    @map("cargo_volume") @db.Decimal(15, 3)
  cargoPackageType String?    @map("cargo_package_type") @db.VarChar(50)
  cargoPackageCount Int?      @map("cargo_package_count")
  
  // 集装箱信息
  containerType   String?     @map("container_type") @db.VarChar(20)
  containerCount  Int?        @map("container_count")
  
  // 船舶信息
  shipName        String?     @map("ship_name") @db.VarChar(100)
  voyageNo        String?     @map("voyage_no") @db.VarChar(50)
  
  // 时间
  etd             DateTime?
  eta             DateTime?
  atd             DateTime?
  ata             DateTime?
  
  // 费用
  totalAmount     Decimal?    @map("total_amount") @db.Decimal(15, 2)
  currency        String?     @default("CNY") @db.VarChar(10)
  
  // 收发货人
  shipperName     String?     @map("shipper_name") @db.VarChar(100)
  shipperAddress  String?     @map("shipper_address") @db.Text
  shipperContact  String?     @map("shipper_contact") @db.VarChar(50)
  shipperPhone    String?     @map("shipper_phone") @db.VarChar(20)
  
  consigneeName   String?     @map("consignee_name") @db.VarChar(100)
  consigneeAddress String?    @map("consignee_address") @db.Text
  consigneeContact String?    @map("consignee_contact") @db.VarChar(50)
  consigneePhone  String?     @map("consignee_phone") @db.VarChar(20)
  
  notifyName      String?     @map("notify_name") @db.VarChar(100)
  notifyAddress   String?     @map("notify_address") @db.Text
  notifyContact   String?     @map("notify_contact") @db.VarChar(50)
  notifyPhone     String?     @map("notify_phone") @db.VarChar(20)
  
  remark          String?     @db.Text
  internalRemark  String?     @map("internal_remark") @db.Text
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  // 关联
  company         Company     @relation(fields: [companyId], references: [id])
  creator         User        @relation(fields: [creatorId], references: [id])
  shipments       Shipment[]
  bills           Bill[]
  
  @@index([orderNo])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// 货物表
model Shipment {
  id              String          @id @default(uuid())
  shipmentNo      String          @unique @map("shipment_no") @db.VarChar(50)
  orderId         String?         @map("order_id")
  companyId       String          @map("company_id")
  
  // 集装箱信息
  containerNo     String          @unique @map("container_no") @db.VarChar(50)
  containerType   String          @map("container_type") @db.VarChar(20)
  blNo            String?         @map("bl_no") @db.VarChar(50)
  bookingNo       String?         @map("booking_no") @db.VarChar(50)
  
  // 船司信息
  carrierCode     String?         @map("carrier_code") @db.VarChar(20)
  carrierName     String?         @map("carrier_name") @db.VarChar(100)
  
  // 状态
  status          ShipmentStatus  @default(BOOKED)
  currentNode     String?         @map("current_node") @db.VarChar(50)
  
  // 港口信息
  originPort      String          @map("origin_port") @db.VarChar(50)
  originPortName  String          @map("origin_port_name") @db.VarChar(100)
  destinationPort String          @map("destination_port") @db.VarChar(50)
  destinationPortName String      @map("destination_port_name") @db.VarChar(100)
  
  // 时间
  etd             DateTime?
  eta             DateTime?
  atd             DateTime?
  ata             DateTime?
  
  // 4portun同步
  syncSource      String?         @map("sync_source") @db.VarChar(50)
  syncId          String?         @map("sync_id") @db.VarChar(100)
  lastSyncAt      DateTime?       @map("last_sync_at")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // 关联
  company         Company         @relation(fields: [companyId], references: [id])
  order           Order?          @relation(fields: [orderId], references: [id])
  nodes           ShipmentNode[]
  pushRecords     InternalPushRecord[]
  subscription    ContainerSubscription?
  
  @@index([containerNo])
  @@index([companyId])
  @@index([status])
  @@index([currentNode])
  @@map("shipments")
}

// 货物节点表
model ShipmentNode {
  id            String    @id @default(uuid())
  shipmentId    String    @map("shipment_id")
  nodeCode      String    @map("node_code") @db.VarChar(50)
  nodeName      String    @map("node_name") @db.VarChar(100)
  location      String?   @db.VarChar(100)
  locationCode  String?   @map("location_code") @db.VarChar(50)
  eventTime     DateTime  @map("event_time")
  description   String?   @db.Text
  operator      String?   @db.VarChar(100)
  source        String    @default("4portun") @db.VarChar(50)
  rawData       Json?     @map("raw_data")
  createdAt     DateTime  @default(now()) @map("created_at")
  
  // 关联
  shipment      Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  @@unique([shipmentId, nodeCode, eventTime])
  @@index([shipmentId, eventTime])
  @@map("shipment_nodes")
}

// 账单表
model Bill {
  id            String      @id @default(uuid())
  billNo        String      @unique @map("bill_no") @db.VarChar(50)
  companyId     String      @map("company_id")
  orderId       String?     @map("order_id")
  
  billType      BillType
  status        BillStatus  @default(DRAFT)
  
  amount        Decimal     @db.Decimal(15, 2)
  currency      String      @default("CNY") @db.VarChar(10)
  
  issueDate     DateTime?   @map("issue_date")
  dueDate       DateTime?   @map("due_date")
  paidDate      DateTime?   @map("paid_date")
  paidAmount    Decimal?    @map("paid_amount") @db.Decimal(15, 2)
  
  remark        String?     @db.Text
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // 关联
  company       Company     @relation(fields: [companyId], references: [id])
  order         Order?      @relation(fields: [orderId], references: [id])
  items         BillItem[]
  invoice       Invoice?
  
  @@index([billNo])
  @@index([companyId])
  @@index([status])
  @@map("bills")
}

// 账单明细表
model BillItem {
  id            String    @id @default(uuid())
  billId        String    @map("bill_id")
  itemCode      String    @map("item_code") @db.VarChar(50)
  itemName      String    @map("item_name") @db.VarChar(100)
  quantity      Decimal   @db.Decimal(15, 3)
  unit          String    @db.VarChar(20)
  unitPrice     Decimal   @map("unit_price") @db.Decimal(15, 4)
  amount        Decimal   @db.Decimal(15, 2)
  currency      String    @default("CNY") @db.VarChar(10)
  remark        String?   @db.Text
  
  // 关联
  bill          Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@map("bill_items")
}

// 发票表
model Invoice {
  id            String        @id @default(uuid())
  invoiceNo     String        @unique @map("invoice_no") @db.VarChar(50)
  billId        String        @unique @map("bill_id")
  companyId     String        @map("company_id")
  
  invoiceType   InvoiceType
  amount        Decimal       @db.Decimal(15, 2)
  taxAmount     Decimal?      @map("tax_amount") @db.Decimal(15, 2)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(15, 2)
  
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime?     @map("issue_date")
  downloadUrl   String?       @map("download_url") @db.VarChar(500)
  
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // 关联
  bill          Bill          @relation(fields: [billId], references: [id])
  
  @@map("invoices")
}

// 系统配置表
model SystemConfig {
  id          String    @id @default(uuid())
  configKey   String    @unique @map("config_key") @db.VarChar(100)
  configValue String    @map("config_value") @db.Text
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@map("system_configs")
}

// 操作日志表
model OperationLog {
  id          String    @id @default(uuid())
  userId      String?   @map("user_id")
  companyId   String?   @map("company_id")
  module      String    @db.VarChar(50)
  action      String    @db.VarChar(50)
  resourceType String   @map("resource_type") @db.VarChar(50)
  resourceId  String?   @map("resource_id") @db.VarChar(100)
  requestData Json?     @map("request_data")
  responseData Json?    @map("response_data")
  ip          String?   @db.VarChar(50)
  userAgent   String?   @map("user_agent") @db.Text
  duration    Int?      // 毫秒
  status      String    @db.VarChar(20)
  errorMsg    String?   @map("error_msg") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([userId, createdAt])
  @@index([companyId, createdAt])
  @@map("operation_logs")
}

// 订单状态变更历史表
model OrderStatusHistory {
  id          String       @id @default(uuid())
  orderId     String       @map("order_id")
  fromStatus  OrderStatus? @map("from_status")
  toStatus    OrderStatus  @map("to_status")
  reason      String?      @db.Text
  remark      String?      @db.Text
  operatorId  String?      @map("operator_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  
  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// 发票申请表
model InvoiceApplication {
  id                String                     @id @default(uuid())
  applicationNo     String                     @unique @map("application_no") @db.VarChar(50)
  companyId         String                     @map("company_id")
  billId            String                     @map("bill_id")
  applicantId       String                     @map("applicant_id")
  
  // 发票信息
  invoiceType       InvoiceType
  titleType         InvoiceTitleType           @map("title_type")
  titleName         String                     @map("title_name") @db.VarChar(100)
  taxNumber         String?                    @map("tax_number") @db.VarChar(50)
  companyAddress    String?                    @map("company_address") @db.VarChar(200)
  companyPhone      String?                    @map("company_phone") @db.VarChar(50)
  bankName          String?                    @map("bank_name") @db.VarChar(100)
  bankAccount       String?                    @map("bank_account") @db.VarChar(50)
  
  // 金额
  amount            Decimal                    @db.Decimal(15, 2)
  taxAmount         Decimal?                   @map("tax_amount") @db.Decimal(15, 2)
  totalAmount       Decimal                    @map("total_amount") @db.Decimal(15, 2)
  
  // 状态
  status            InvoiceApplicationStatus   @default(PENDING)
  remark            String?                    @db.Text
  reviewedBy        String?                    @map("reviewed_by")
  reviewedAt        DateTime?                  @map("reviewed_at")
  reviewRemark      String?                    @map("review_remark") @db.Text
  
  // 关联发票
  invoiceId         String?                    @map("invoice_id")
  
  createdAt         DateTime                   @default(now()) @map("created_at")
  updatedAt         DateTime                   @updatedAt @map("updated_at")
  
  @@index([companyId])
  @@index([billId])
  @@index([status])
  @@map("invoice_applications")
}

// 支付凭证表
model PaymentVoucher {
  id                String                @id @default(uuid())
  billId            String                @map("bill_id")
  companyId         String                @map("company_id")
  uploaderId        String                @map("uploader_id")
  
  // 凭证信息
  voucherNo         String?               @map("voucher_no") @db.VarChar(50)
  amount            Decimal               @db.Decimal(15, 2)
  paymentDate       DateTime              @map("payment_date")
  paymentMethod     PaymentMethod         @map("payment_method")
  
  // 文件
  fileUrl           String                @map("file_url") @db.VarChar(500)
  fileName          String                @map("file_name") @db.VarChar(255)
  fileSize          Int                   @map("file_size")
  
  // 状态
  status            VoucherStatus         @default(PENDING)
  remark            String?               @db.Text
  
  // 审核
  verifiedBy        String?               @map("verified_by")
  verifiedAt        DateTime?             @map("verified_at")
  verifyRemark      String?               @map("verify_remark") @db.Text
  
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  
  @@index([billId])
  @@index([companyId])
  @@index([status])
  @@map("payment_vouchers")
}

// 账单状态变更历史表
model BillStatusHistory {
  id          String       @id @default(uuid())
  billId      String       @map("bill_id")
  fromStatus  BillStatus?  @map("from_status")
  toStatus    BillStatus   @map("to_status")
  reason      String?      @db.Text
  operatorId  String?      @map("operator_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  
  @@index([billId])
  @@index([createdAt])
  @@map("bill_status_history")
}

// 企业认证信息表
model CompanyVerification {
  id                  String   @id @default(uuid())
  companyId           String   @unique @map("company_id")
  businessLicenseUrl  String?  @map("business_license_url") @db.VarChar(500)
  legalPersonName     String?  @map("legal_person_name") @db.VarChar(100)
  legalPersonIdCard   String?  @map("legal_person_id_card") @db.VarChar(50)
  verificationStatus  String   @default("PENDING") @map("verification_status") @db.VarChar(50)
  submittedAt         DateTime @default(now()) @map("submitted_at")
  reviewedAt          DateTime? @map("reviewed_at")
  reviewerId          String?  @map("reviewer_id")
  reviewRemark        String?  @map("review_remark") @db.Text
  remark              String?  @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@index([verificationStatus])
  @@index([submittedAt])
  @@map("company_verifications")
}
enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

enum CompanyStatus {
  PENDING    // 待审核
  ACTIVE     // 正常
  SUSPENDED  // 暂停
  REJECTED   // 拒绝
}

enum CompanyRole {
  ADMIN      // 企业管理员
  OPERATOR   // 业务操作员
  FINANCE    // 财务人员
  READONLY   // 只读用户
}

enum OrderType {
  FCL        // 整箱
  LCL        // 拼箱
  AIR        // 空运
  LAND       // 陆运
  MULTIMODAL // 多式联运
}

enum OrderStatus {
  PENDING     // 待确认
  CONFIRMED   // 已确认
  PROCESSING  // 执行中
  COMPLETED   // 已完成
  CANCELLED   // 已取消
  REJECTED    // 已拒绝
}

enum ShipmentStatus {
  BOOKED      // 已订舱
  EMPTY_PICKUP // 提空箱
  GATE_IN     // 进港
  CUSTOMS_RELEASED // 海关放行
  TERMINAL_RELEASED // 码头放行
  DEPARTURE   // 离港
  ARRIVAL     // 抵港
  DISCHARGED  // 卸船
  FULL_PICKUP // 提重箱
  EMPTY_RETURN // 还空箱
  COMPLETED   // 已完成
}

enum BillType {
  FREIGHT     // 运费
  AGENCY      // 代理费
  CUSTOMS     // 报关费
  INSURANCE   // 保险费
  OTHER       // 其他
}

enum BillStatus {
  DRAFT       // 草稿
  ISSUED      // 已开具
  PARTIAL_PAID // 部分支付
  PAID        // 已支付
  OVERDUE     // 逾期
  CANCELLED   // 已取消
}

enum InvoiceType {
  VAT_SPECIAL     // 增值税专用发票
  VAT_NORMAL      // 增值税普通发票
  PROFORMA        // 形式发票
  COMMERCIAL      // 商业发票
}

enum InvoiceStatus {
  DRAFT       // 草稿
  ISSUED      // 已开具
  SENT        // 已发送
  RECEIVED    // 已接收
  CANCELLED   // 已作废
}

// 发票抬头类型
enum InvoiceTitleType {
  ENTERPRISE    // 企业
  PERSONAL      // 个人
}

// 发票申请状态
enum InvoiceApplicationStatus {
  PENDING     // 待审核
  APPROVED    // 已批准
  REJECTED    // 已拒绝
  INVOICED    // 已开票
  CANCELLED   // 已取消
}

// 支付方式
enum PaymentMethod {
  BANK_TRANSFER   // 银行转账
  ALIPAY          // 支付宝
  WECHAT_PAY      // 微信支付
  CASH            // 现金
  CHECK           // 支票
  OTHER           // 其他
}

// 凭证状态
enum VoucherStatus {
  PENDING     // 待审核
  VERIFIED    // 已确认
  REJECTED    // 已拒绝
}

// 通知表
model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  type        String    @db.VarChar(50)
  title       String    @db.VarChar(200)
  content     String    @db.Text
  link        String?   @db.VarChar(500)
  metadata    Json?
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// 订阅表
model ShipmentSubscription {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  containerNo   String    @map("container_no") @db.VarChar(50)
  email         String?   @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  notifyOnUpdate Boolean @default(true) @map("notify_on_update")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  @@unique([userId, containerNo])
  @@index([containerNo])
  @@map("shipment_subscriptions")
}

// 同步日志表
model SyncLog {
  id          String       @id @default(uuid())
  shipmentId  String       @map("shipment_id") @db.VarChar(100)
  syncType    String       @map("sync_type") @db.VarChar(50)
  status      SyncLogStatus @default(PENDING)
  message     String?      @db.Text
  syncedAt    DateTime     @default(now()) @map("synced_at")

  @@index([shipmentId])
  @@index([syncType])
  @@index([status])
  @@index([syncedAt])
  @@map("sync_logs")
}

// 内部推送记录表
model InternalPushRecord {
  id              String    @id @default(uuid())
  containerNo     String    @map("container_no") @db.VarChar(50)
  shipmentId      String?   @map("shipment_id") @db.VarChar(100)
  source          String    @db.VarChar(50) // 数据来源: 4portun, manual
  pushType        String    @map("push_type") @db.VarChar(50) // 推送类型: webhook, api, batch
  status          PushStatus @default(PENDING)
  payload         Json?     // 推送的数据内容
  response        Json?     // 内部系统响应
  errorMsg        String?   @map("error_msg") @db.Text
  retryCount      Int       @default(0) @map("retry_count")
  pushedAt        DateTime? @map("pushed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关联
  shipment        Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([containerNo])
  @@index([shipmentId])
  @@index([status])
  @@index([createdAt])
  @@map("internal_push_records")
}

// 集装箱订阅管理表
model ContainerSubscription {
  id                String    @id @default(uuid())
  containerNo       String    @unique @map("container_no") @db.VarChar(50)
  shipmentId        String?   @unique @map("shipment_id") @db.VarChar(100)
  companyId         String?   @map("company_id") @db.VarChar(100)
  
  // 订阅状态
  isSubscribed      Boolean   @default(true) @map("is_subscribed")
  subscribedAt      DateTime? @map("subscribed_at")
  unsubscribedAt    DateTime? @map("unsubscribed_at")
  
  // 4portun 订阅状态
  externalSubscribed Boolean  @default(false) @map("external_subscribed")
  externalSubId     String?   @map("external_sub_id") @db.VarChar(100)
  
  // 同步配置
  autoSync          Boolean   @default(true) @map("auto_sync")
  syncInterval      Int       @default(300) @map("sync_interval") // 同步间隔(秒)
  lastSyncAt        DateTime? @map("last_sync_at")
  nextSyncAt        DateTime? @map("next_sync_at")
  
  // 统计信息
  totalPushes       Int       @default(0) @map("total_pushes")
  lastPushAt        DateTime? @map("last_push_at")
  
  // 元数据
  metadata          Json?
  remark            String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // 关联
  shipment          Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([containerNo])
  @@index([shipmentId])
  @@index([companyId])
  @@index([isSubscribed])
  @@index([externalSubscribed])
  @@index([lastSyncAt])
  @@map("container_subscriptions")
}

enum SyncLogStatus {
  PENDING   // 待同步
  SUCCESS   // 同步成功
  FAILED    // 同步失败
  RETRYING  // 重试中
}

enum PushStatus {
  PENDING    // 待推送
  PUSHING    // 推送中
  SUCCESS    // 推送成功
  FAILED     // 推送失败
  RETRYING   // 重试中
}

# 货代客户门户 - 技术方案设计

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              接入层                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │   客户Web端   │  │   小程序     │  │  管理后台    │                       │
│  │  (Next.js)   │  │  (微信原生)   │  │  (Next.js)   │                       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                       │
└─────────┼─────────────────┼─────────────────┼───────────────────────────────┘
          │                 │                 │
          └─────────────────┴─────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────────────────┐
│                           网关层                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         API Gateway (Kong/Nginx)                     │   │
│  │  - 统一认证鉴权  - 限流熔断  - 负载均衡  - 日志记录  - 协议转换       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────▼───────────────────────────────────────────────────────────────────┐
│                          应用服务层 (微服务架构)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  用户服务    │ │  订单服务    │ │  货物服务    │ │  财务服务    │          │
│  │  auth-svc   │ │  order-svc  │ │ shipment-svc│ │ billing-svc │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  通知服务    │ │  同步服务    │ │  AI服务      │ │  文件服务    │          │
│  │ notify-svc  │ │  sync-svc   │ │   ai-svc    │ │  file-svc   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────────────┐
│         │                      数据层                                        │
├─────────┼───────────────────────────────────────────────────────────────────┤
│         │                                                                     │
│  ┌──────▼──────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  PostgreSQL │ │    Redis    │Elasticsearch│   MinIO     │          │
│  │   (主库)    │ │   (缓存)    │   (搜索)    │  (文件存储)  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────────────┐
│         │                    外部集成层                                      │
├─────────┼───────────────────────────────────────────────────────────────────┤
│         │                                                                     │
│  ┌──────▼──────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  客户ERP    │ │   4portun   │ │   微信支付   │ │   支付宝    │          │
│  │   系统      │ │   API平台   │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 服务划分

| 服务名 | 职责 | 端口 | 技术栈 |
|--------|------|------|--------|
| auth-service | 用户认证、权限管理、SSO | 3001 | NestJS + JWT |
| customer-service | 客户管理、企业信息 | 3002 | NestJS |
| order-service | 订单管理、委托单 | 3003 | NestJS + 工作流 |
| shipment-service | 货物跟踪、状态管理 | 3004 | NestJS |
| billing-service | 账单、发票、支付 | 3005 | NestJS |
| sync-service | ERP同步、4portun同步 | 3006 | NestJS + Bull |
| ai-service | 智能客服、OCR、预测 | 3007 | Python/FastAPI |
| notify-service | 消息通知、微信模板 | 3008 | NestJS |
| file-service | 文件上传下载 | 3009 | NestJS + MinIO |

---

## 2. 技术选型

### 2.1 前端技术栈

#### 客户Web端 / 管理后台
| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 14.x | React框架，支持SSR/SSG |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 3.x | 原子化CSS |
| shadcn/ui | - | UI组件库 |
| TanStack Query | 5.x | 数据获取与缓存 |
| Zustand | 4.x | 状态管理 |
| Axios | 1.x | HTTP客户端 |
| Recharts | 2.x | 数据可视化 |

#### 小程序
| 技术 | 用途 |
|------|------|
| 微信小程序原生 | 核心框架 |
| TDesign小程序组件库 | UI组件 |
| miniprogram-computed | 计算属性 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| NestJS | 10.x | Node.js框架 |
| TypeScript | 5.x | 开发语言 |
| Prisma | 5.x | ORM |
| PostgreSQL | 15.x | 主数据库 |
| Redis | 7.x | 缓存/会话 |
| RabbitMQ | 3.x | 消息队列 |
| Elasticsearch | 8.x | 搜索引擎 |
| MinIO | - | 对象存储 |
| Bull | 4.x | 任务队列 |

### 2.3 AI技术栈

| 技术 | 用途 |
|------|------|
| Python 3.11 | 开发语言 |
| FastAPI | Web框架 |
| OpenAI API / 文心一言 | LLM服务 |
| PaddleOCR / 腾讯云OCR | 文档识别 |
| scikit-learn | 预测模型 |

### 2.4 基础设施

| 技术 | 用途 |
|------|------|
| Docker | 容器化 |
| Kubernetes | 容器编排 |
| Nginx / Kong | API网关 |
| Prometheus + Grafana | 监控告警 |
| ELK Stack | 日志收集 |
| GitHub Actions | CI/CD |

---

## 3. 数据库设计

### 3.1 核心表结构

```sql
-- 用户与权限
users (用户表)
- id, username, email, phone, password_hash, status, created_at

companies (企业表)
- id, company_name, credit_code, address, contact_name, contact_phone, status

user_company_rel (用户企业关联)
- id, user_id, company_id, role (admin/operator/finance/readonly)

-- 订单
orders (订单表)
- id, order_no, company_id, creator_id, 
- type (fcl/lcl/air/land), status,
- origin_port, destination_port,
- cargo_desc, cargo_weight, cargo_volume,
- container_type, container_count,
- ship_name, voyage_no,
- etd, eta, atd, ata,
- total_amount, currency,
- created_at, updated_at

-- 货物跟踪
shipments (货物表)
- id, shipment_no, order_id, company_id,
- container_no, bl_no, booking_no,
- carrier_code, carrier_name,
- status, current_node,
- origin_port, destination_port,
- etd, eta, atd, ata,
- created_at, updated_at

shipment_nodes (货物节点表)
- id, shipment_id, node_code, node_name,
- location, event_time, description,
- source (4portun/erp/manual)

-- 财务
bills (账单表)
- id, bill_no, company_id, order_id,
- bill_type, status, amount, currency,
- issue_date, due_date, paid_date,
- created_at

invoices (发票表)
- id, invoice_no, bill_id, company_id,
- invoice_type, amount, tax_amount,
- status, issue_date,
- download_url

payments (支付记录表)
- id, payment_no, bill_id, company_id,
- payment_method, amount, status,
- transaction_id, paid_at

-- 系统
sync_logs (同步日志表)
- id, source, target, entity_type, entity_id,
- status, request_data, response_data,
- error_msg, created_at
```

### 3.2 分库分表策略

- **按客户ID分片**：客户数据按company_id取模分片
- **历史数据归档**：超过2年的订单数据归档到历史库
- **读写分离**：查询走从库，写入走主库

---

## 4. 关键流程设计

### 4.1 货物状态同步流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 4portun  │────▶│ Webhook  │────▶│  API网关  │────▶│ sync-svc │
│  平台    │     │  接收器   │     │          │     │          │
└──────────┘     └──────────┘     └──────────┘     └────┬─────┘
                                                         │
                              ┌──────────────────────────┼──────────┐
                              ▼                          ▼          ▼
                         ┌─────────┐               ┌─────────┐ ┌─────────┐
                         │ 消息队列 │               │ 数据库   │ │  缓存   │
                         │RabbitMQ │               │PostgreSQL│ │  Redis  │
                         └─────────┘               └─────────┘ └─────────┘
                              │
                              ▼
                         ┌─────────┐
                         │通知服务  │────▶ 微信推送/站内消息
                         └─────────┘
```

### 4.2 ERP数据同步流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   ERP    │◀───▶│  同步服务 │◀───▶│  消息队列 │◀───▶│  客户门户 │
│  系统    │     │sync-svc  │     │ RabbitMQ │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
     │
     ▼
┌──────────┐
│ 数据转换  │
│ 适配器    │
└──────────┘
```

### 4.3 订单创建流程

```
用户下单
    │
    ▼
┌─────────┐
│ 订单校验 │
└────┬────┘
     │
     ▼
┌─────────┐     ┌─────────┐
│ 保存订单 │────▶│ 同步ERP │
└────┬────┘     └─────────┘
     │
     ▼
┌─────────┐     ┌─────────┐
│ 生成账单 │────▶│ 通知客户 │
└─────────┘     └─────────┘
```

---

## 5. API设计规范

### 5.1 接口规范

- **协议**: HTTPS
- **格式**: JSON
- **编码**: UTF-8
- **版本**: v1 (URL路径 `/api/v1/`)

### 5.2 响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1708080000000,
  "requestId": "req_xxx"
}
```

### 5.3 错误码定义

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |
| 503 | 服务暂不可用 |

---

## 6. 安全设计

### 6.1 认证鉴权

- **JWT Token**: Access Token (15分钟) + Refresh Token (7天)
- **小程序**: 微信登录 + code2session
- **API调用**: API Key + 签名验证

### 6.2 数据安全

- 传输加密: TLS 1.3
- 存储加密: AES-256
- 敏感字段: 手机号、身份证脱敏显示
- 密码: bcrypt加密存储

### 6.3 防护措施

- API限流: 100次/分钟/IP
- SQL注入: 参数化查询
- XSS: 输入过滤+输出编码
- CSRF: Token验证

---

## 7. 部署架构

### 7.1 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡 (Nginx)                      │
└─────────────────────────────────────────────────────────────┘
          │
    ┌─────┴─────┐
    ▼           ▼
┌─────────┐ ┌─────────┐
│ Web服务1 │ │ Web服务2 │  ... (多实例)
└─────────┘ └─────────┘
    │           │
    └─────┬─────┘
          ▼
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes集群                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │auth-svc │ │order-svc│ │billing- │ │sync-svc │           │
│  │   x2   │ │   x3   │ │  svc x2 │ │   x2   │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
          │
    ┌─────┴─────┐
    ▼           ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│PostgreSQL│ │  Redis  │ │RabbitMQ │
│ 主从集群 │ │  集群   │ │  集群   │
└─────────┘ └─────────┘ └─────────┘
```

### 7.2 环境规划

| 环境 | 用途 | 配置 |
|------|------|------|
| dev | 开发环境 | 单实例 |
| test | 测试环境 | 双实例 |
| staging | 预发布 | 同生产 |
| prod | 生产环境 | 多实例+集群 |

---

## 8. 开发计划

### 8.1 里程碑

| 阶段 | 周期 | 交付物 |
|------|------|--------|
| 第一阶段 | 4周 | 基础架构、用户认证、货物查询 |
| 第二阶段 | 4周 | 订单管理、ERP对接、4portun对接 |
| 第三阶段 | 3周 | 财务中心、支付对接、小程序 |
| 第四阶段 | 2周 | 管理后台、AI功能、测试优化 |
| 第五阶段 | 1周 | 部署上线、培训、运维交接 |

**总计：14周（约3.5个月）**

### 8.2 团队配置

| 角色 | 人数 | 职责 |
|------|------|------|
| 项目经理 | 1 | 项目管理、需求沟通 |
| 前端工程师 | 2 | Web端、小程序开发 |
| 后端工程师 | 3 | 微服务开发、API设计 |
| DevOps工程师 | 1 | 基础设施、CI/CD |
| 测试工程师 | 1 | 功能测试、性能测试 |
| UI设计师 | 1 | 界面设计、交互设计 |

---

## 9. 风险评估

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| ERP对接复杂 | 高 | 提前获取接口文档，预留2周缓冲 |
| 4portun数据延迟 | 中 | 本地缓存+多数据源备份 |
| 性能瓶颈 | 中 | 压测+水平扩展方案 |
| 安全漏洞 | 高 | 代码审计+渗透测试 |

---

## 10. 待确认技术事项

- [ ] ERP系统接口协议（REST/SOAP/其他）
- [ ] ERP系统数据格式（JSON/XML）
- [ ] 4portun API配额和并发限制
- [ ] 服务器部署环境（云厂商/自建）
- [ ] 域名和SSL证书
- [ ] 微信小程序账号（需客户注册）
- [ ] 微信支付/支付宝商户号

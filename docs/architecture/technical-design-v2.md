# 货代客户门户 - 技术方案设计（简化版）

## 1. 系统架构（单体+模块化）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              接入层                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │   客户Web端   │  │   小程序     │  │  管理后台    │                       │
│  │  (Next.js)   │  │  (微信原生)   │  │  (Next.js)   │                       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                       │
└─────────┼─────────────────┼─────────────────┼───────────────────────────────┘
          │                 │                 │
          └─────────────────┴─────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────────────────┐
│                           网关层 (Nginx)                                     │
│                    - 负载均衡 - 静态资源缓存 - SSL终止                        │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────▼───────────────────────────────────────────────────────────────────┐
│                        应用服务层 (单体架构)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         主应用 (Node.js/NestJS)                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │   │
│  │  │用户模块  │ │订单模块  │ │货物模块  │ │财务模块  │ │同步模块  │      │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘      │   │
│  │                                                                     │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │   │
│  │  │通知模块  │ │AI模块    │ │文件模块  │                               │   │
│  │  └─────────┘ └─────────┘ └─────────┘                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────────────┐
│         │                      数据层                                        │
├─────────┼───────────────────────────────────────────────────────────────────┤
│         │                                                                     │
│  ┌──────▼──────┐ ┌─────────────┐ ┌─────────────┐                          │
│  │  PostgreSQL │ │    Redis    │    MinIO     │                          │
│  │   (主库)    │ │   (缓存)    │   (文件存储)  │                          │
│  └─────────────┘ └─────────────┘ └─────────────┘                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────────────┐
│         │                    外部集成层                                      │
├─────────┼───────────────────────────────────────────────────────────────────┤
│         │                                                                     │
│  ┌──────▼──────┐ ┌─────────────┐                                           │
│  │   4portun   │ │    Kimi     │                                           │
│  │   API平台   │ │    AI API   │                                           │
│  └─────────────┘ └─────────────┘                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 技术选型（简化版）

### 2.1 前端技术栈

| 产品 | 技术 | 说明 |
|------|------|------|
| 客户Web端 | Next.js 14 + TypeScript | React框架，支持SSR |
| 管理后台 | Next.js 14 + Ant Design Pro | 中后台脚手架，快速开发 |
| 小程序 | 微信小程序原生 + TDesign | 腾讯官方组件库 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 | 备注 |
|------|------|------|------|
| Node.js | 20.x LTS | 运行环境 | 长期支持版 |
| NestJS | 10.x | Web框架 | 模块化设计，渐进式开发 |
| TypeScript | 5.x | 开发语言 | 类型安全 |
| Prisma | 5.x | ORM | 类型安全的数据库访问 |
| PostgreSQL | 15.x | 主数据库 | 阿里云RDS |
| Redis | 7.x | 缓存/会话 | 阿里云Redis |
| MinIO | - | 文件存储 | 阿里云OSS替代方案 |

### 2.3 AI技术栈

| 技术 | 用途 |
|------|------|
| Kimi API (Moonshot) | 智能客服、文本生成 |
| 百度OCR / 腾讯OCR | 提单/发票识别 |

### 2.4 基础设施（阿里云）

| 服务 | 阿里云产品 | 用途 |
|------|-----------|------|
| 服务器 | ECS (2-4核8G起步) | 应用部署 |
| 数据库 | RDS PostgreSQL | 主数据库 |
| 缓存 | 云数据库Redis | 缓存/会话 |
| 文件存储 | OSS | 文件/图片存储 |
| 负载均衡 | SLB | 流量分发（后期扩展）|
| CDN | 阿里云CDN | 静态资源加速 |
| 监控 | 云监控 + SLS | 基础监控、日志 |

---

## 3. 为什么不使用微服务？

### 3.1 中小企业场景特点

| 特点 | 说明 |
|------|------|
| 用户规模 | 初期100-500家企业客户 |
| 并发量 | 日均1000-5000次查询 |
| 开发团队 | 3-5人小团队 |
| 迭代速度 | 需要快速响应需求变化 |
| 运维能力 | 有限的运维资源 |

### 3.2 单体架构优势

| 优势 | 说明 |
|------|------|
| 开发简单 | 一个代码库，开发调试方便 |
| 部署简单 | 单包部署，回滚容易 |
| 事务简单 | 本地事务，数据一致性易保障 |
| 成本低 | 服务器资源需求少 |
| 维护简单 | 日志集中，问题排查快 |

### 3.3 模块化设计

虽然用单体架构，但代码层面保持模块化：

```
src/
├── modules/
│   ├── auth/           # 用户认证模块
│   ├── customer/       # 客户管理模块
│   ├── order/          # 订单管理模块
│   ├── shipment/       # 货物跟踪模块
│   ├── billing/        # 财务模块
│   ├── sync/           # 数据同步模块
│   ├── ai/             # AI能力模块
│   └── notify/         # 通知模块
├── common/             # 公共工具、拦截器
├── config/             # 配置文件
└── main.ts             # 入口文件
```

**未来可扩展**：当某个模块成为瓶颈时，可以相对容易地拆分为独立服务。

---

## 4. 为什么不使用Docker+K8s？

### 4.1 当前阶段不需要

| 因素 | 现状 | 是否需要K8s |
|------|------|------------|
| 服务器数量 | 1-2台ECS | 不需要 |
| 部署频率 | 每周1-2次 | 不需要 |
| 服务数量 | 1个主应用 | 不需要 |
| 自动扩缩容 | 手动升配即可 | 不需要 |
| 团队经验 | 可能无K8s经验 | 学习成本高 |

### 4.2 简化部署方案

```
开发环境 ──▶ 测试环境 ──▶ 生产环境
    │           │           │
    ▼           ▼           ▼
 本地开发    单台ECS     单台/双台ECS
 pm2启动     pm2启动      Nginx反向代理
            (Git拉取+重启)   + pm2集群模式
```

### 4.3 使用PM2管理Node进程

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'freight-portal',
    script: './dist/main.js',
    instances: 'max',        // 根据CPU核心数启动多进程
    exec_mode: 'cluster',    // 集群模式
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    max_memory_restart: '1G',  // 内存超限自动重启
    restart_delay: 3000,
    max_restarts: 5
  }]
};
```

### 4.4 部署脚本示例

```bash
#!/bin/bash
# deploy.sh

echo "开始部署..."

# 1. 拉取代码
git pull origin main

# 2. 安装依赖
npm ci

# 3. 执行数据库迁移
npx prisma migrate deploy

# 4. 构建
npm run build

# 5. 使用PM2平滑重启
pm2 reload ecosystem.config.js --env production

echo "部署完成"
```

---

## 5. 监控方案（阿里云原生）

### 5.1 不使用Prometheus+Grafana

原因：
- 需要额外服务器资源部署
- 需要维护监控配置
- 学习成本较高

### 5.2 使用阿里云监控

| 监控项 | 阿里云产品 | 说明 |
|--------|-----------|------|
| 服务器监控 | 云监控 | CPU、内存、磁盘、网络 |
| 应用监控 | ARMS | APM性能监控、调用链 |
| 日志收集 | SLS日志服务 | 日志收集、查询、告警 |
| 数据库监控 | RDS控制台 | 慢查询、连接数、性能 |
| Redis监控 | Redis控制台 | 内存、命中率、连接数 |

### 5.3 日志方案

```typescript
// 使用Winston + SLS传输
import winston from 'winston';
import SLSTransport from 'winston-sls-transport';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    // 本地文件
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    // 阿里云SLS
    new SLSTransport({
      project: 'freight-portal-logs',
      logstore: 'app-logs',
      // ...
    })
  ]
});
```

---

## 6. 数据库设计（简化）

### 6.1 核心表

```sql
-- 用户表
users (id, username, email, phone, password_hash, role, company_id, status, created_at)

-- 企业表
companies (id, name, credit_code, address, contact_name, contact_phone, status, created_at)

-- 订单表
orders (id, order_no, company_id, creator_id, type, status, origin_port, destination_port, 
        cargo_desc, cargo_weight, container_type, container_count, etd, eta, total_amount, created_at)

-- 货物表
shipments (id, shipment_no, order_id, company_id, container_no, bl_no, carrier_code, 
           status, current_node, origin_port, destination_port, etd, eta, created_at)

-- 货物节点表
shipment_nodes (id, shipment_id, node_code, node_name, location, event_time, source, created_at)

-- 账单表
bills (id, bill_no, company_id, order_id, amount, currency, status, issue_date, due_date, created_at)

-- 发票表
invoices (id, invoice_no, bill_id, company_id, amount, status, download_url, created_at)

-- 同步日志表
sync_logs (id, source, entity_type, entity_id, status, error_msg, created_at)
```

### 6.2 阿里云RDS配置建议

| 规格 | 配置 | 价格（参考） |
|------|------|-------------|
| 起步 | 2核4G + 100G SSD | ~200元/月 |
| 推荐 | 4核8G + 200G SSD | ~500元/月 |
| 高阶 | 8核16G + 500G SSD | ~1200元/月 |

---

## 7. 阿里云部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户访问                              │
└─────────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    ▼               ▼
            ┌───────────┐    ┌───────────┐
            │   CDN     │    │  微信小程序 │
            │(静态资源) │    │   云开发   │
            └─────┬─────┘    └───────────┘
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                      阿里云ECS (应用服务器)                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Nginx (反向代理 + 静态文件)                           │  │
│  │  ┌───────────────────────────────────────────────┐   │  │
│  │  │  Node.js App (PM2集群模式)                      │   │  │
│  │  │  - 端口: 3000                                  │   │  │
│  │  │  - 进程数: 2-4 (根据CPU核心)                    │   │  │
│  │  └───────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  RDS         │   │  Redis       │   │  OSS         │
│ PostgreSQL   │   │  缓存/会话    │   │  文件存储     │
└──────────────┘   └──────────────┘   └──────────────┘
```

### 7.1 服务器配置建议

| 阶段 | ECS配置 | 数量 | 月费用 |
|------|---------|------|--------|
| 起步 | 2核4G 5M带宽 | 1台 | ~200元 |
| 推荐 | 4核8G 10M带宽 | 1-2台 | ~400-800元 |
| 扩展 | 4核8G 10M带宽 | 2台+SLB | ~1000元 |

---

## 8. 开发计划（调整版）

### 8.1 里程碑

| 阶段 | 周期 | 交付物 |
|------|------|--------|
| 第一阶段 | 3周 | 基础架构、用户认证、货物查询（4portun对接） |
| 第二阶段 | 3周 | 订单管理、财务中心、管理后台 |
| 第三阶段 | 2周 | 小程序、AI功能（Kimi接入） |
| 第四阶段 | 2周 | 测试优化、阿里云部署、上线 |

**总计：10周（约2.5个月）**

### 8.2 团队配置（精简）

| 角色 | 人数 | 职责 |
|------|------|------|
| 全栈工程师 | 2 | 前后端开发、接口对接 |
| 前端工程师 | 1 | 小程序开发、Web界面 |
| 项目经理 | 1 | 需求沟通、项目管理 |

**共4人**

---

## 9. 成本估算（月度）

| 项目 | 起步配置 | 推荐配置 |
|------|---------|---------|
| ECS服务器 | 200元 | 400元 |
| RDS PostgreSQL | 200元 | 500元 |
| Redis | 100元 | 200元 |
| OSS存储 | 50元 | 100元 |
| CDN流量 | 50元 | 100元 |
| 域名+证书 | 0元（已有） | 0元 |
| Kimi API | 100元 | 300元 |
| 4portun API | 500元 | 1000元 |
| **总计** | **~1200元/月** | **~2600元/月** |

---

## 10. 技术决策总结

| 决策 | 选择 | 理由 |
|------|------|------|
| 架构 | 单体+模块化 | 中小企业场景，简单高效 |
| 容器化 | 否 | 资源有限，PM2足够 |
| K8s | 否 | 过度设计，增加复杂度 |
| 监控 | 阿里云原生 | 免维护，成本低 |
| AI | Kimi API | 国内服务，中文支持好 |
| 支付 | 暂不接 | 先走线下对公转账 |
| ERP对接 | 暂不接 | 先手动录入，后续再评估 |

---

## 11. 文件清单

已更新文档：
1. `docs/requirements/PRD-v3.md` - 需求文档（已确认）
2. `docs/architecture/technical-design-v2.md` - 技术方案（本文档）
3. `docs/api/4portun-integration.md` - 四港物流宝集成（已有key）

废弃/暂不使用的方案：
- 微服务架构（保留参考）
- Docker+K8s部署方案（保留参考）
- ERP双向对接方案（改为后续评估）

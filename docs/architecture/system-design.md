# 系统架构设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                │
├─────────────┬─────────────┬─────────────┬─────────────────────┤
│   Web端     │   移动端    │  小程序     │    第三方集成       │
│  (Next.js)  │(React Native)│ (微信/钉钉) │   (API/Webhook)     │
└──────┬──────┴──────┬──────┴──────┬──────┴──────────┬──────────┘
       │             │             │                 │
       └─────────────┴──────┬──────┴─────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────────┐
│                      API网关层 (Kong/Nginx)                    │
│              认证、限流、负载均衡、日志                          │
└───────────────────────────┬───────────────────────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────────┐
│                      应用服务层 (NestJS)                        │
├──────────┬──────────┬──────────┬──────────┬───────────────────┤
│ 用户服务 │ 货物服务 │ 订单服务 │ 财务服务 │   AI服务          │
├──────────┼──────────┼──────────┼──────────┼───────────────────┤
│ 同步服务 │ 通知服务 │ 文件服务 │ 搜索服务 │   分析服务        │
└──────────┴────┬─────┴──────────┴──────────┴───────────────────┘
                │
┌───────────────▼───────────────────────────────────────────────┐
│                      数据层                                    │
├──────────────┬──────────────┬──────────────┬──────────────────┤
│ PostgreSQL   │    Redis     │ Elasticsearch│   MinIO/S3       │
│  (主数据库)   │  (缓存/会话)  │   (搜索)     │  (文件存储)      │
└──────────────┴──────────────┴──────────────┴──────────────────┘
                │
┌───────────────▼───────────────────────────────────────────────┐
│                    外部集成层                                  │
├──────────────┬──────────────┬──────────────┬──────────────────┤
│  内部ERP系统  │  船公司API   │   港口系统   │   支付平台       │
├──────────────┼──────────────┼──────────────┼──────────────────┤
│  海关系统     │   地图服务   │   AI服务     │   消息推送       │
└──────────────┴──────────────┴──────────────┴──────────────────┘
```

## 2. 微服务划分

| 服务名 | 职责 | 技术要点 |
|--------|------|----------|
| auth-service | 认证授权 | JWT、OAuth2、SSO |
| customer-service | 客户管理 | 多租户、组织架构 |
| shipment-service | 货物追踪 | 事件溯源、状态机 |
| order-service | 订单管理 | 工作流引擎 |
| billing-service | 财务计费 | 精度计算、对账 |
| sync-service | 数据同步 | 定时任务、幂等性 |
| ai-service | AI能力 | LLM、OCR、预测 |
| notification-service | 消息通知 | 多渠道推送 |

## 3. 数据库设计原则

### 3.1 分库分表策略
- 按客户ID分片（多租户）
- 历史数据归档（超过2年）

### 3.2 核心实体
- 用户 (users)
- 企业 (companies)
- 货物/集装箱 (shipments)
- 订单 (orders)
- 账单 (invoices)
- 同步日志 (sync_logs)

## 4. 安全架构

```
┌─────────────────────────────────────────┐
│           WAF / DDoS防护                 │
├─────────────────────────────────────────┤
│           API网关认证                    │
│    (JWT验证 + 签名验证 + 限流)            │
├─────────────────────────────────────────┤
│           服务间通信                     │
│    (mTLS + 服务网格)                     │
├─────────────────────────────────────────┤
│           数据加密                       │
│    (传输TLS + 存储AES)                   │
└─────────────────────────────────────────┘
```

## 5. AI 架构

```
┌─────────────────────────────────────────┐
│           应用层                         │
│  智能客服 | 文档识别 | 预测分析 | 推荐   │
├─────────────────────────────────────────┤
│           AI编排层 (LangChain)           │
│  Prompt管理 | 上下文管理 | 工具调用      │
├─────────────────────────────────────────┤
│           模型层                         │
│  GPT-4 | Claude | 文心一言 | 本地模型    │
├─────────────────────────────────────────┤
│           数据处理                       │
│  OCR | 向量化 | 知识库 | 微调            │
└─────────────────────────────────────────┘
```

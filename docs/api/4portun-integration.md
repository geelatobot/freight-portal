# 第三方API集成方案 - 四港物流宝(4portun)

## 1. 平台概述

**四港物流宝**是浙江四港联动发展有限公司运营的海运物流数据平台，提供全球海运物流全程可视化服务。

- **官网**: https://tracking.4portun.com/
- **公司**: 浙江四港联动发展有限公司
- **联系方式**: zjsg_log@4portun.com / 13205918562
- **地址**: 杭州市西湖区西溪新座7幢5楼

## 2. 提供的API服务

### 2.1 箱货跟踪API
提供集装箱全链路节点跟踪，覆盖以下场景：

| 数据类型 | 覆盖范围 | 节点示例 |
|---------|---------|---------|
| 货物跟踪 | 全国10大口岸 | 放箱、提空箱、进港、海关放行、码头放行、离港、抵港、卸货、提重、还空 |
| 船司数据 | 全球70+船司 | 提空箱、进港、ETD/ATD、ETA/ATA、卸货、提货、还空 |
| 海外码头 | 美、日、韩30+码头 | 免费提箱最后截止日(LFD)、堆场地点、可提箱状态、放行状态、码头费用 |
| 中国EIR | 国内八大港区堆场 | 提空箱、放箱、进港、海关放行、装箱单发送、VGM发送、集港 |

### 2.2 关务数据API (4.0)
支持海+陆+空海关数据跟踪：
- 预配舱单
- 海关入库
- 通关审结
- 海关放行
- 装载舱单
- 结关

### 2.3 美国海关数据
- 空运、海运形式的美国海关进口信息
- 海关查验状态
- 海关放行状态
- 内陆转关信息
- 空运信息
- 货物清单

### 2.4 海运综合API
覆盖多式联运场景：
- 支线运输
- 内河运输
- 卡车运输

## 3. 推荐集成方案

### 3.1 核心集成API

```
┌─────────────────────────────────────────────────────────────┐
│                    货代客户门户                              │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 箱货跟踪API   │ │ 关务数据API   │ │ 海运综合API   │
│ (4portun)    │ │ (4portun)    │ │ (4portun)    │
└──────────────┘ └──────────────┘ └──────────────┘
        │               │               │
        └───────────────┴───────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │   数据聚合层     │
              │  (内部系统+     │
              │   第三方数据)   │
              └─────────────────┘
```

### 3.2 数据订阅模式

**推荐采用订阅模式而非轮询模式：**

```
┌─────────────┐     订阅请求      ┌─────────────┐
│  客户门户    │ ───────────────▶ │  4portun    │
│  (Webhook)  │                  │   平台      │
│             │ ◀─────────────── │             │
└─────────────┘   状态变更推送    └─────────────┘
                        │
                        │ 数据变更
                        ▼
              ┌─────────────────┐
              │  消息队列(RabbitMQ)│
              └─────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
   ┌─────────┐    ┌─────────┐    ┌─────────┐
   │ 通知服务 │    │ 数据存储 │    │ 缓存更新 │
   └─────────┘    └─────────┘    └─────────┘
```

### 3.3 数据同步策略

| 数据类型 | 同步频率 | 同步方式 | 优先级 |
|---------|---------|---------|--------|
| 在途货物状态 | 实时/5分钟 | Webhook推送 | P0 |
| 船期信息 | 每日2次 | 定时拉取 | P1 |
| 海关状态 | 实时/15分钟 | Webhook推送 | P0 |
| 港区状态 | 实时/10分钟 | Webhook推送 | P1 |
| 历史数据 | 按需 | 手动触发 | P2 |

## 4. 技术集成要点

### 4.1 API认证
- 方式: API Key + 签名验证
- 建议: 使用HTTPS传输，密钥定期轮换

### 4.2 数据映射

**4portun节点 → 内部标准节点**

| 4portun节点 | 内部标准节点 | 说明 |
|------------|-------------|------|
| 放箱 | CONTAINER_RELEASED | 船公司放箱 |
| 提空箱 | EMPTY_PICKUP | 提空箱 |
| 进港 | GATE_IN | 重箱进港 |
| 海关放行 | CUSTOMS_RELEASED | 海关放行 |
| 码头放行 | TERMINAL_RELEASED | 码头放行 |
| 离港 | DEPARTURE | 船舶离港 |
| 抵港 | ARRIVAL | 船舶抵港 |
| 卸货 | DISCHARGED | 卸船 |
| 提重 | FULL_PICKUP | 提重箱 |
| 还空 | EMPTY_RETURN | 还空箱 |

### 4.3 异常处理

```javascript
// 伪代码示例
async function syncContainerStatus(containerNo) {
  try {
    const data = await fourportunAPI.query(containerNo);
    
    // 数据校验
    if (!data || !data.nodes) {
      throw new DataNotFoundError(`Container ${containerNo} not found`);
    }
    
    // 数据转换
    const standardData = transformToStandardFormat(data);
    
    // 保存到数据库
    await saveToDatabase(standardData);
    
    // 更新缓存
    await updateCache(containerNo, standardData);
    
    // 检查异常
    const anomalies = detectAnomalies(standardData);
    if (anomalies.length > 0) {
      await alertService.sendAlert({
        type: 'CONTAINER_ANOMALY',
        containerNo,
        anomalies
      });
    }
    
  } catch (error) {
    // 分级重试
    if (error.isRetryable) {
      await retryQueue.add({
        task: 'syncContainer',
        containerNo,
        retryCount: 0,
        maxRetries: 3
      });
    } else {
      await errorLogService.log(error);
    }
  }
}
```

## 5. 与内部系统的整合

### 5.1 数据流架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         货代客户门户                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 货物查询  │  │ 订单管理  │  │ 财务中心  │  │ 消息通知  │        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │
│       │             │             │             │              │
│       └─────────────┴──────┬──────┴─────────────┘              │
│                            │                                    │
│                    ┌───────┴───────┐                           │
│                    │   业务逻辑层   │                           │
│                    └───────┬───────┘                           │
│                            │                                    │
│       ┌────────────────────┼────────────────────┐              │
│       ▼                    ▼                    ▼              │
│  ┌──────────┐       ┌──────────┐       ┌──────────┐           │
│  │ 内部ERP  │       │ 4portun  │       │ 其他第三方 │           │
│  │  WMS/TMS │       │   API    │       │   API    │           │
│  └──────────┘       └──────────┘       └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 数据一致性保障

1. **主从数据源定义**
   - 订单主数据：内部ERP
   - 物流轨迹：4portun API（主）+ 内部系统（补充）
   - 财务数据：内部财务系统

2. **冲突解决策略**
   - 时间戳优先：取最新更新时间的数据
   - 数据源优先级：内部系统 > 4portun > 其他第三方
   - 人工确认：关键节点变更需人工复核

## 6. 实施建议

### 6.1 分阶段实施

**第一阶段（MVP）**
- 箱货跟踪API集成
- 基础数据展示
- 订阅推送功能

**第二阶段**
- 关务数据API集成
- 异常预警功能
- 数据报表

**第三阶段**
- 海运综合API集成
- AI预测功能
- 多式联运跟踪

### 6.2 需要确认的事项

- [ ] 4portun API接口文档获取
- [ ] API调用配额和费用
- [ ] Webhook回调地址配置
- [ ] 数据订阅的具体节点范围
- [ ] SLA保障等级
- [ ] 数据安全和隐私协议

## 7. 联系方式

如需开通4portun API服务，请联系：
- 邮箱：zjsg_log@4portun.com
- 电话：13205918562（工作日 09:00-17:30）
- 公司：浙江四港联动发展有限公司
- 地址：杭州市西湖区西溪新座7幢5楼

# 货运门户项目 - 详细任务拆解与执行计划

> 生成时间: 2026-02-18
> 基于 PRD-v3.1 + 技术设计 v2 + 现有代码分析

---

## 一、项目现状分析

### 1.1 已完成模块 ✅

| 模块 | 完成度 | 说明 |
|------|--------|------|
| 数据库设计 | 100% | Prisma Schema 完整定义，含所有枚举和索引 |
| 后端架构 | 80% | NestJS 模块化结构，9个业务模块已创建 |
| 认证模块 | 90% | JWT + 刷新令牌，登录/注册/权限 |
| 订单模块 | 70% | CRUD 完成，待完善业务逻辑 |
| 货物模块 | 60% | 基础结构完成，4portun 集成待完善 |
| 财务模块 | 50% | 账单/发票模型完成，业务逻辑待实现 |
| 同步模块 | 40% | SyncService 框架完成，FourPortunService 待实现 |
| AI 模块 | 60% | Kimi API 接入完成，智能客服框架完成 |
| 通知模块 | 30% | 模块创建，具体实现待完成 |

### 1.2 核心待办 🔴

1. **测试覆盖率为 0** - 所有测试任务 pending
2. **前端未开始** - Web/Admin/小程序全部待开发
3. **4portun API 未实际对接** - 只有框架代码
4. **安全审计未进行** - 输入验证、SQL 注入防护
5. **部署流程未验证** - 仅文档，未实际部署

---

## 二、功能点详细拆解

### 阶段一：基础架构完善（Week 1-2）

#### 1.1 后端基础加固

**任务 1.1.1: 统一错误处理与日志**
- [ ] 创建全局异常过滤器 (GlobalExceptionFilter)
- [ ] 统一 API 响应格式 { code, message, data, timestamp }
- [ ] 集成 Winston 日志系统
- [ ] 配置日志分级（error/warn/info/debug）
- [ ] 日志写入本地文件 + 阿里云 SLS
- [ ] 敏感信息脱敏（密码、手机号、API Key）

**任务 1.1.2: 输入验证与安全防护**
- [ ] 全局 ValidationPipe 配置
- [ ] 所有 DTO 添加 class-validator 装饰器
- [ ] SQL 注入防护（Prisma 参数化查询检查）
- [ ] XSS 防护（输入过滤、输出转义）
- [ ] 请求频率限制（Throttler 已配置，需细化规则）
- [ ] CORS 配置审查
- [ ] 安全响应头（Helmet）

**任务 1.1.3: 数据库优化**
- [ ] 审查所有 Prisma 查询，添加必要索引
- [ ] 慢查询日志配置
- [ ] 连接池优化
- [ ] Redis 缓存层接入
  - 用户会话缓存
  - 货物状态缓存（5分钟 TTL）
  - API 响应缓存

#### 1.2 4portun API 深度集成

**任务 1.2.1: FourPortunService 完整实现**
```typescript
// 需实现的方法清单
- authenticate(): Promise<AuthToken>           // API 认证
- trackContainer(containerNo): Promise<TrackingData>  // 单箱查询
- trackBatch(containers): Promise<BatchResult>        // 批量查询
- subscribeWebhook(events): Promise<WebhookConfig>    // 订阅推送
- verifyWebhookSignature(payload, signature): boolean // 验签
- refreshToken(): Promise<AuthToken>                  // 令牌刷新
```

**任务 1.2.2: 数据映射与标准化**
- [ ] 4portun 节点码 → 内部标准节点码映射表
- [ ] 船司代码标准化（MSC/CMA/MSK...）
- [ ] 港口代码标准化（CNSHG/JPTYO...）
- [ ] 异常状态识别与标记

**任务 1.2.3: 同步策略实现**
- [ ] 定时任务：每 5 分钟同步在途货物
- [ ] Webhook 接收端点实现
- [ ] 消息队列（Redis/Bull）处理异步同步
- [ ] 同步失败重试机制（指数退避）
- [ ] 同步日志记录与监控

**任务 1.2.4: 货物状态预警**
- [ ] 延误预警（ETD/ETA 偏差 > 24h）
- [ ] 异常节点预警（海关查验、扣货等）
- [ ] 即将到港提醒（ETA 前 48h/24h）
- [ ] 超期未提箱预警（LFD 前 24h）

---

### 阶段二：核心业务功能（Week 3-5）

#### 2.1 订单管理完善

**任务 2.1.1: 订单生命周期管理**
```
PENDING → CONFIRMED → PROCESSING → COMPLETED
   ↓          ↓            ↓
REJECTED   CANCELLED    (异常状态)
```
- [ ] 订单状态机实现（状态转换校验）
- [ ] 订单审核流程（企业管理员审批）
- [ ] 订单变更历史记录
- [ ] 订单关联货物自动创建

**任务 2.1.2: 订单文档管理**
- [ ] 提单（B/L）上传与解析
- [ ] 订舱确认书管理
- [ ] 装箱单（Packing List）上传
- [ ] 商业发票（Commercial Invoice）管理
- [ ] 文档版本控制

**任务 2.1.3: 订单费用预估**
- [ ] 运费计算（按柜型/重量/体积）
- [ ] 附加费模板（THC/文件费/封条费等）
- [ ] 费用明细生成
- [ ] 预估费用与实际费用对比

#### 2.2 财务中心

**任务 2.2.1: 账单管理**
- [ ] 账单自动生成（基于订单/货物）
- [ ] 账单审核与发布
- [ ] 账单状态流转：DRAFT → ISSUED → PARTIAL_PAID/PAID
- [ ] 账单明细 CRUD
- [ ] 账单 PDF 生成与下载

**任务 2.2.2: 发票管理**
- [ ] 发票申请流程
- [ ] 发票开具（对接税控系统或手工录入）
- [ ] 发票状态跟踪
- [ ] 发票下载（PDF）
- [ ] 发票作废/红冲

**任务 2.2.3: 支付凭证**
- [ ] 线下支付凭证上传
- [ ] 凭证审核流程
- [ ] 支付与账单关联
- [ ] 支付历史查询

**任务 2.2.4: 财务统计**
- [ ] 应收账款统计
- [ ] 账龄分析（30/60/90天）
- [ ] 收款统计报表
- [ ] 客户对账单生成

#### 2.3 客户管理

**任务 2.3.1: 企业认证**
- [ ] 企业信息提交（营业执照、信用代码）
- [ ] 企业资质审核流程
- [ ] 审核状态通知
- [ ] 企业信息变更

**任务 2.3.2: 信用管理**
- [ ] 信用额度设置
- [ ] 信用额度使用跟踪
- [ ] 超信用预警
- [ ] 信用调整记录

**任务 2.3.3: 用户权限**
- [ ] 企业角色管理（ADMIN/OPERATOR/FINANCE/READONLY）
- [ ] 权限矩阵定义
- [ ] 数据范围控制（只能看本企业数据）
- [ ] 操作日志记录

---

### 阶段三：前端开发（Week 4-7）

#### 3.1 客户 Web 端（Next.js 14）

**任务 3.1.1: 项目脚手架**
- [ ] Next.js 14 + TypeScript 初始化
- [ ] Tailwind CSS + shadcn/ui 配置
- [ ] 路由结构规划
- [ ] API Client 封装（axios + 拦截器）
- [ ] 全局状态管理（Zustand/React Query）

**任务 3.1.2: 认证与布局**
- [ ] 登录/注册页面
- [ ] 企业认证引导
- [ ] 主布局（Sidebar + Header + Content）
- [ ] 权限守卫（Protected Route）

**任务 3.1.3: 货物跟踪（核心功能）**
- [ ] 集装箱查询输入框
- [ ] 货物状态卡片展示
- [ ] 时间轴节点展示
- [ ] 地图轨迹展示（可选）
- [ ] 订阅/取消订阅

**任务 3.1.4: 订单中心**
- [ ] 订单列表（筛选/分页）
- [ ] 订单详情页
- [ ] 新建订单表单
- [ ] 订单状态跟踪
- [ ] 订单文档上传

**任务 3.1.5: 财务中心**
- [ ] 账单列表
- [ ] 账单详情与支付
- [ ] 发票申请
- [ ] 发票列表与下载
- [ ] 财务概览仪表盘

**任务 3.1.6: 个人中心**
- [ ] 企业信息展示
- [ ] 用户管理（企业管理员）
- [ ] 消息通知
- [ ] 修改密码

#### 3.2 管理后台（Ant Design Pro）

**任务 3.2.1: 项目初始化**
- [ ] Ant Design Pro 脚手架
- [ ] 菜单与路由配置
- [ ] 权限控制（RBAC）

**任务 3.2.2: 企业管理**
- [ ] 企业列表与审核
- [ ] 企业详情与编辑
- [ ] 信用额度管理

**任务 3.2.3: 订单管理**
- [ ] 全部订单列表
- [ ] 订单审核
- [ ] 订单编辑（内部备注）

**任务 3.2.4: 货物管理**
- [ ] 集装箱列表
- [ ] 手动同步 4portun
- [ ] 节点数据查看

**任务 3.2.5: 财务管理**
- [ ] 账单管理
- [ ] 发票开具
- [ ] 支付凭证审核
- [ ] 财务报表

**任务 3.2.6: 系统管理**
- [ ] 用户管理
- [ ] 角色权限
- [ ] 系统配置
- [ ] 操作日志

#### 3.3 微信小程序

**任务 3.3.1: 基础框架**
- [ ] 小程序项目初始化
- [ ] TDesign 组件库集成
- [ ] 登录与授权

**任务 3.3.2: 核心功能**
- [ ] 货物查询（首页）
- [ ] 货物详情
- [ ] 订单列表
- [ ] 账单查看
- [ ] 消息通知

---

### 阶段四：测试与质量保障（Week 6-8）

#### 4.1 单元测试

**任务 4.1.1: Service 层测试**
- [ ] AuthService 测试（登录/注册/令牌）
- [ ] CustomerService 测试
- [ ] OrderService 测试（含状态机）
- [ ] ShipmentService 测试
- [ ] BillingService 测试
- [ ] SyncService 测试（含 Mock 4portun）
- [ ] AiService 测试（Mock Kimi API）

**任务 4.1.2: 工具类测试**
- [ ] 加密/解密工具
- [ ] 日期处理工具
- [ ] 数据验证工具

#### 4.2 集成测试

**任务 4.2.1: Controller 测试**
- [ ] AuthController 集成测试
- [ ] OrderController 集成测试
- [ ] 端到端 API 流程测试

**任务 4.2.2: 数据库集成测试**
- [ ] Prisma 事务测试
- [ ] 并发操作测试

#### 4.3 E2E 测试

**任务 4.3.1: 核心流程测试**
- [ ] 用户注册 → 登录 → 查询货物 完整流程
- [ ] 创建订单 → 审核 → 关联货物 流程
- [ ] 账单生成 → 支付 → 开票 流程

#### 4.4 性能测试

**任务 4.4.1: 负载测试**
- [ ] API 响应时间测试
- [ ] 并发用户测试（100/500/1000）
- [ ] 数据库性能测试

**任务 4.4.2: 安全测试**
- [ ] SQL 注入测试
- [ ] XSS 测试
- [ ] 越权访问测试
- [ ] 敏感信息泄露测试

---

### 阶段五：部署与运维（Week 8-9）

#### 5.1 部署准备

**任务 5.1.1: 环境配置**
- [ ] 生产环境变量配置
- [ ] 阿里云 RDS 创建与配置
- [ ] 阿里云 Redis 创建与配置
- [ ] 阿里云 OSS 创建与配置
- [ ] 域名与 SSL 证书

**任务 5.1.2: 部署脚本**
- [ ] 自动化部署脚本完善
- [ ] 数据库迁移脚本
- [ ] 回滚脚本
- [ ] 健康检查端点

#### 5.2 监控与告警

**任务 5.2.1: 应用监控**
- [ ] 阿里云 ARMS 接入
- [ ] 自定义业务指标（订单量、同步成功率等）
- [ ] 错误率监控

**任务 5.2.2: 日志系统**
- [ ] 阿里云 SLS 接入
- [ ] 日志查询仪表盘
- [ ] 关键错误告警

**任务 5.2.3: 告警配置**
- [ ] 服务器资源告警（CPU/内存/磁盘）
- [ ] 应用异常告警
- [ ] 4portun 同步失败告警
- [ ] 数据库慢查询告警

---

## 三、任务优先级矩阵

### P0 - 上线阻塞（必须完成）

| 任务 | 预估工时 | 依赖 |
|------|----------|------|
| 统一错误处理与日志 | 8h | - |
| 输入验证与安全防护 | 12h | - |
| FourPortunService 完整实现 | 16h | - |
| 订单生命周期管理 | 12h | - |
| 账单管理核心功能 | 12h | - |
| 客户 Web 端 - 货物跟踪 | 24h | API 完成 |
| 客户 Web 端 - 订单中心 | 20h | API 完成 |
| 管理后台 - 企业/订单管理 | 24h | API 完成 |
| Service 层单元测试 | 20h | 业务代码 |
| 部署脚本与环境配置 | 16h | - |

### P1 - 重要功能（上线后 2 周内完成）

| 任务 | 预估工时 | 依赖 |
|------|----------|------|
| 数据库优化与缓存 | 8h | - |
| 货物状态预警 | 8h | 4portun 集成 |
| 订单文档管理 | 8h | 文件存储 |
| 发票管理 | 8h | 账单管理 |
| 财务统计报表 | 8h | 财务数据 |
| 客户 Web 端 - 财务中心 | 16h | 财务 API |
| 管理后台 - 财务管理 | 12h | 财务 API |
| Controller 集成测试 | 12h | - |
| E2E 测试 | 16h | 前端完成 |
| 监控与告警 | 12h | 部署完成 |

### P2 - 增强功能（上线后 1 个月内完成）

| 任务 | 预估工时 | 依赖 |
|------|----------|------|
| OCR 识别（提单/发票） | 16h | - |
| 微信小程序 | 40h | Web 端完成 |
| AI 智能客服增强 | 12h | - |
| 性能优化 | 12h | 上线后数据 |
| 高级报表与数据分析 | 16h | - |

---

## 四、执行计划（甘特图）

```
Week:    1       2       3       4       5       6       7       8       9
         ├───────┼───────┼───────┼───────┼───────┼───────┼───────┼───────┤
阶段一   ████████
基础架构         └───────┘

阶段二           ████████████████
后端业务                 └───────┘

阶段三                   ████████████████████████
前端开发                         └───────┘       └───────┘

阶段四                           ████████████████████
测试保障                                 └───────┘

阶段五                                           ████████████████
部署上线                                                   └───────┘
```

---

## 五、风险与应对

| 风险 | 概率 | 影响 | 应对策略 |
|------|------|------|----------|
| 4portun API 文档不全 | 中 | 高 | 提前联系技术支持，预留缓冲时间 |
| 前端开发延期 | 高 | 中 | 优先完成核心页面，MVP 上线 |
| 测试覆盖不足 | 中 | 高 | 核心流程必须测试，边缘功能可后补 |
| 第三方服务不稳定 | 低 | 高 | 设计降级策略，本地缓存兜底 |
| 安全漏洞 | 中 | 高 | 代码审查 + 安全测试工具扫描 |

---

## 六、资源需求

### 人员配置

| 角色 | 人数 | 职责 |
|------|------|------|
| 全栈工程师 | 1 | 后端核心 + 部署运维 |
| 前端工程师 | 1 | Web 端 + 管理后台 |
| 测试工程师 | 0.5 | 测试用例 + 自动化测试 |

### 云服务成本（月度）

| 服务 | 起步配置 | 预估费用 |
|------|----------|----------|
| ECS | 2核4G | 200元 |
| RDS MySQL | 2核4G | 200元 |
| Redis | 1G | 100元 |
| OSS | 50G | 50元 |
| CDN | 100G流量 | 50元 |
| 4portun API | - | 500元 |
| Kimi API | - | 100元 |
| **总计** | | **~1200元/月** |

---

## 七、下一步行动

根据当前状态，建议按以下顺序执行：

1. **立即开始**：FourPortunService 完整实现（阻塞后续货物功能）
2. **并行进行**：输入验证与安全防护（影响所有模块）
3. **本周内**：统一错误处理与日志（影响开发效率）
4. **下周开始**：客户 Web 端货物跟踪页面（MVP 核心）

是否需要我针对某个具体任务开始执行？
